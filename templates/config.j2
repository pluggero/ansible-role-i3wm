# =============================================================================
# Variables & Setup
# =============================================================================
set $mod {{ i3wm_modifier }}

# Workspace Variables
{% for workspace in i3wm_workspaces %}
set $workspace{{ workspace.id }} "{{ workspace.name }}"
{% endfor %}

# =============================================================================
# Core Configuration
# =============================================================================
font pango:{{ i3wm_font.family }} {{ i3wm_font.size }}

# Gaps
gaps inner {{ i3wm_gaps.inner }}
gaps outer {{ i3wm_gaps.outer }}

# Focus Settings
focus_follows_mouse {{ i3wm_focus_follows_mouse | ansible.builtin.ternary('yes', 'no' ) }}
focus_wrapping yes
focus_on_window_activation smart
mouse_warping output

# Use Mouse+$mod to drag floating windows to their wanted position
floating_modifier $mod

# Workspace Layout
default_orientation horizontal
workspace_layout default
workspace_auto_back_and_forth no

# Border Layout
default_border {{ i3wm_borders.default }} {{ i3wm_borders.width }}
default_floating_border {{ i3wm_borders.default_floating }} {{ i3wm_borders.width }}
hide_edge_borders {{ i3wm_borders.hide_edge_borders }}

# =============================================================================
# Colors
# =============================================================================
client.focused {{ i3wm_colors.focused.border }} {{ i3wm_colors.focused.background }} {{ i3wm_colors.focused.text }} {{ i3wm_colors.focused.indicator }} {{ i3wm_colors.focused.child_border }}
client.focused_inactive {{ i3wm_colors.focused_inactive.border }} {{ i3wm_colors.focused_inactive.background }} {{ i3wm_colors.focused_inactive.text }} {{ i3wm_colors.focused_inactive.indicator }} {{ i3wm_colors.focused_inactive.child_border }}
client.unfocused {{ i3wm_colors.unfocused.border }} {{ i3wm_colors.unfocused.background }} {{ i3wm_colors.unfocused.text }} {{ i3wm_colors.unfocused.indicator }} {{ i3wm_colors.unfocused.child_border }}
client.urgent {{ i3wm_colors.urgent.border }} {{ i3wm_colors.urgent.background }} {{ i3wm_colors.urgent.text }} {{ i3wm_colors.urgent.indicator }} {{ i3wm_colors.urgent.child_border }}
client.placeholder {{ i3wm_colors.placeholder.border }} {{ i3wm_colors.placeholder.background }} {{ i3wm_colors.placeholder.text }} {{ i3wm_colors.placeholder.indicator }} {{ i3wm_colors.placeholder.child_border }}
client.background {{ i3wm_colors.background }}

# =============================================================================
# Keybindings
# =============================================================================
# Workspace Switching
{% for workspace in i3wm_workspaces %}
bindsym $mod+{{ workspace.id }} workspace $workspace{{ workspace.id }}
{% endfor %}

# Move Container to Workspace
{% for workspace in i3wm_workspaces %}
bindsym $mod+Shift+{{ workspace.id }} move container to workspace $workspace{{ workspace.id }}
{% endfor %}

# Application Execution
{% for keybinding in i3wm_keybindings_exec %}
bindsym {{ keybinding.key }} exec --no-startup-id {{ keybinding.exec }}
{% endfor %}

# Window Focus
{% for keybinding in i3wm_keybindings_focus %}
bindsym {{ keybinding.key }} {{ keybinding.action }}
{% endfor %}

# Window Movement
{% for keybinding in i3wm_keybindings_move %}
bindsym {{ keybinding.key }} {{ keybinding.action }}
{% endfor %}

# Layout Control
{% for keybinding in i3wm_keybindings_layout %}
bindsym {{ keybinding.key }} {{ keybinding.action }}
{% endfor %}

# System Control
{% for keybinding in i3wm_keybindings_system %}
bindsym {{ keybinding.key }} {{ keybinding.action }}
{% endfor %}

# Media/Hardware Controls
{% if i3wm_enable_media_keys %}
{% for name, keybinding in i3wm_keybindings_media.items() %}
bindsym {{ keybinding.key }} {{ keybinding.action }}
{% endfor %}
{% endif %}

# Quick Resize (outside resize mode)
{% for keybinding in i3wm_keybindings_quick_resize %}
bindsym {{ keybinding.key }} {{ keybinding.action }}
{% endfor %}

# Resize Mode
bindsym {{ i3wm_keybindings_resize.enter_key }} mode "resize"
mode "resize" {
{% for keybinding in i3wm_keybindings_resize.bindings %}
  bindsym {{ keybinding.key }} {{ keybinding.action }}
{% endfor %}
}

# =============================================================================
# Workspace & Monitor Setup
# =============================================================================
# Workspace Monitor Assignment
{% for monitor in i3wm_monitors %}
{%     for workspace in monitor.workspaces %}
workspace $workspace{{ workspace }} output {{ monitor.output }}
{%     endfor %}
{% endfor %}

# Application Workspace Assignment
{% for application in i3wm_applications %}
assign [class="{{ application.class }}"] $workspace{{ application.workspace }}
{% endfor %}

# =============================================================================
# Status Bar Configuration
# =============================================================================
bar {
  id main
  font pango:{{ i3wm_font.family }} {{ i3wm_font.size }}
  status_command i3blocks
  position top
  mode dock
  modifier None
  colors {
    background {{ i3wm_bar_colors.background }}
    statusline {{ i3wm_bar_colors.statusline }}
    separator {{ i3wm_bar_colors.separator }}
    focused_workspace {{ i3wm_bar_colors.focused_workspace.border }} {{ i3wm_bar_colors.focused_workspace.background }} {{ i3wm_bar_colors.focused_workspace.text }}
    active_workspace {{ i3wm_bar_colors.active_workspace.border }} {{ i3wm_bar_colors.active_workspace.background }} {{ i3wm_bar_colors.active_workspace.text }}
    inactive_workspace {{ i3wm_bar_colors.inactive_workspace.border }} {{ i3wm_bar_colors.inactive_workspace.background }} {{ i3wm_bar_colors.inactive_workspace.text }}
    urgent_workspace {{ i3wm_bar_colors.urgent_workspace.border }} {{ i3wm_bar_colors.urgent_workspace.background }} {{ i3wm_bar_colors.urgent_workspace.text }}
    binding_mode {{ i3wm_bar_colors.binding_mode.border }} {{ i3wm_bar_colors.binding_mode.background }} {{ i3wm_bar_colors.binding_mode.text }}
  }
}

# =============================================================================
# Startup Commands
# =============================================================================
# System Setup (always executed)
{% for command in i3wm_exec_always %}
exec_always --no-startup-id {{ command }}
{% endfor %}

# Monitor Setup
exec_always sleep 1 && xrandr \
{% for monitor in i3wm_monitors %} \
  --output {{ monitor.output }} \
  --mode {{ monitor.mode }} \
  --pos {{ monitor.pos }} \
  --rotate {{ monitor.rotate }}
{% endfor %}

# Background/Wallpaper
{% if i3wm_wallpaper | bool %}
exec_always feh --bg-scale {{ i3wm_wallpaper_image }}
{% endif %}

# System Behavior Settings
{% if i3wm_screensaver | bool == false %}
# Disable screensaver
exec_always xset s off
exec xset -dpms
{% endif %}

{% if i3wm_disable_beep | bool %}
exec_always xset b off
{% endif %}

{% if i3wm_xautolock | bool %}
exec xautolock -time {{ i3wm_screensaver_time }} -locker 'maim /tmp/screen_locked.png; mogrify -scale 10% -scale 1000% /tmp/screen_locked.png; i3lock -i /tmp/screen_locked.png'
{% endif %}

# Application Startup
{% for application in i3wm_applications if application.on_startup %}
exec sleep 5 && {{ application.name }}
{% endfor %}

{% for app in i3wm_run_on_startup %}
exec sleep 12 && {{ i3wm_run_on_startup }}
{% endfor %}
